local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

local NORMAL_WALK_SPEED = humanoid.WalkSpeed
local NORMAL_JUMP_POWER = humanoid.JumpPower

local flyingEnabled = false
local goingUp = false
local goingDown = false

local velocityForce

local MAX_SPEED = 20
local VERTICAL_ACCELERATION = 5

local currentVertical = 0

local function EnableFly()
    flyingEnabled = true

    if not velocityForce then
        velocityForce = Instance.new("BodyVelocity")
        velocityForce.Name = "VelocityForce"
        velocityForce.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        velocityForce.Velocity = Vector3.new(0, 0, 0)
        velocityForce.Parent = hrp
    end

    humanoid.WalkSpeed = 0
    humanoid.JumpPower = 0
    hrp.Anchored = false

    goingUp = false
    goingDown = false
    currentVertical = 0
end

local function DisableFly()
    flyingEnabled = false

    if velocityForce then
        velocityForce:Destroy()
        velocityForce = nil
    end

    humanoid.WalkSpeed = NORMAL_WALK_SPEED
    humanoid.JumpPower = NORMAL_JUMP_POWER
    hrp.Anchored = false

    goingUp = false
    goingDown = false
    currentVertical = 0
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    if input.KeyCode == Enum.KeyCode.F then
        if flyingEnabled then
            DisableFly()
        else
            EnableFly()
        end
    end

    if not flyingEnabled then return end

    if input.KeyCode == Enum.KeyCode.Space then
        goingUp = true
    elseif input.KeyCode == Enum.KeyCode.LeftShift then
        goingDown = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if not flyingEnabled then return end

    if input.KeyCode == Enum.KeyCode.Space then
        goingUp = false
    elseif input.KeyCode == Enum.KeyCode.LeftShift then
        goingDown = false
    end
end)

RunService.Heartbeat:Connect(function(dt)
    if not flyingEnabled then return end

    local moveDir = humanoid.MoveDirection
    local horizontalVelocity = Vector3.new(moveDir.X, 0, moveDir.Z) * MAX_SPEED

    local targetVertical = 0
    if goingUp and not goingDown then
        targetVertical = MAX_SPEED
    elseif goingDown and not goingUp then
        targetVertical = -MAX_SPEED
    end
    currentVertical = currentVertical + (targetVertical - currentVertical) * math.min(1, VERTICAL_ACCELERATION * dt)

    if velocityForce then
        velocityForce.Velocity = Vector3.new(horizontalVelocity.X, currentVertical, horizontalVelocity.Z)
    end
end)
